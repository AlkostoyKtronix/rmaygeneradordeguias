<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Registros</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos anteriores (sin cambios) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            min-width: 100vw;
            overflow-x: hidden;
        }
        .titulo {
            width: 100%;
            background-color: #000000;
            text-align: center;
            color: white;
            margin-bottom: 0px;
            padding: 15px 0;
        }
        .botones-container {
            background-color: #000000;
            margin-top: 0px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding: 20px 0;
            border: 40px solid #000000;
            box-sizing: border-box;
        }
        .botones-container button {
            background-color: #000000;
            color: white;
            padding: 12px 20px;
            border: 2px solid white;
            border-radius: 5px;
            margin: 2px;
            cursor: pointer;
            font-size: 16px;
        }
        .botones-container button:hover {
            background-color: #333;
        }
        
        /* Estilos para la p치gina de registros */
        .contenedor-registros {
            width: 95%;
            margin: 20px auto;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .filtros-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .filtro-grupo {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        
        .filtro-grupo label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .filtro-grupo input, .filtro-grupo select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        
        .botones-accion {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .boton-exportar {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .boton-exportar:hover {
            background-color: #218838;
        }
        
        .boton-refrescar {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .boton-refrescar:hover {
            background-color: #138496;
        }
        
        .tabla-contenedor {
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #000;
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .paginacion {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .paginacion button {
            padding: 8px 15px;
            background-color: #000;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .paginacion button:hover {
            background-color: #333;
        }
        
        .paginacion button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .contador-registros {
            margin-top: 15px;
            text-align: right;
            font-style: italic;
            color: #666;
        }
        
        .cargando {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        
        .sin-registros {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
        }
        
        .filtro-rango {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .filtro-rango button {
            padding: 8px 12px;
            background-color: #000;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .filtros-container {
                flex-direction: column;
            }
            
            .filtro-grupo {
                width: 100%;
            }
            
            .filtro-rango {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="titulo">
        <h1>Historial de Registros - CONFIRN</h1>
    </div>
    <div class="botones-container">
        <button onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i> Volver al Formulario</button>
        <button onclick="window.location.href='PLANTILLAS_DEVOLUCIONES.html'"><i class="fas fa-file-pdf"></i> Generador PDF</button>
    </div>

    <div class="contenedor-registros">
        <h2>Registros Guardados</h2>
        
        <div class="filtros-container">
            <div class="filtro-grupo">
                <label for="filtro-fecha">Fecha espec칤fica</label>
                <input type="date" id="filtro-fecha">
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-mes">Filtrar por mes</label>
                <select id="filtro-mes">
                    <option value="">Seleccionar mes</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-anio">A침o</label>
                <select id="filtro-anio">
                    <option value="">Seleccionar a침o</option>
                </select>
            </div>
            
            <div class="filtro-grupo">
                <label>Rango de fechas</label>
                <div class="filtro-rango">
                    <div>
                        <label for="filtro-fecha-inicio" style="font-size: 12px;">Desde</label>
                        <input type="date" id="filtro-fecha-inicio">
                    </div>
                    <div>
                        <label for="filtro-fecha-fin" style="font-size: 12px;">Hasta</label>
                        <input type="date" id="filtro-fecha-fin">
                    </div>
                    <button onclick="aplicarRangoFechas()"><i class="fas fa-filter"></i></button>
                </div>
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-gestor">Gestor</label>
                <select id="filtro-gestor">
                    <option value="">Todos los gestores</option>
                    <option value="LUIS FERNANDO GUTIERREZ TORRES">LUIS FERNANDO GUTIERREZ TORRES</option>
                    <option value="JOSE EXNEYDER HOYOS VARGAS">JOSE EXNEYDER HOYOS VARGAS</option>
                    <option value="CARLOS EDUARDO CASAS">CARLOS EDUARDO CASAS</option>
                    <option value="JUAN MANUEL PUENTES POLANIA">JUAN MANUEL PUENTES POLANIA</option>
                    <option value="JOHAN SEBASTIAN OVALLE">JOHAN SEBASTIAN OVALLE</option>
                    <option value="CARLOS CA칌AS">CARLOS CA칌AS</option>
                    <option value="ERIK HERNANDEZ">ERIK HERNANDEZ</option>
                    <option value="KARELLY QUITIAN URREA">KARELLY QUITIAN URREA</option>
                    <option value="DANIELA DUCUARA QUESADA">DANIELA DUCUARA QUESADA</option>
                    <option value="BENJAMIN PRIETO">BENJAMIN PRIETO</option>
                    <option value="CRISTIAN FERNANDO BERNAL OVIEDO">CRISTIAN FERNANDO BERNAL OVIEDO</option>
                    <option value="ANA LILIANA MARQUEZ">ANA LILIANA MARQUEZ</option>
                </select>
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-factura">N춿 Factura</label>
                <input type="text" id="filtro-factura" placeholder="Buscar por factura">
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-caso">Caso</label>
                <input type="text" id="filtro-caso" placeholder="Buscar por caso">
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-motivo">Motivo</label>
                <select id="filtro-motivo">
                    <option value="">Todos los motivos</option>
                    <option value="FALLA">FALLA</option>
                    <option value="INSATISFACCION">INSATISFACCION</option>
                    <option value="INCOMPLETO">INCOMPLETO</option>
                    <option value="DETERIORADO">DETERIORADO</option>
                    <option value="PANTALLA ROTA">PANTALLA ROTA</option>
                </select>
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-proceso">Proceso</label>
                <select id="filtro-proceso">
                    <option value="">Todos los procesos</option>
                    <option value="BONO DEVOLUCION">BONO DEVOLUCION</option>
                    <option value="BONO SERVICIO">BONO SERVICIO</option>
                    <option value="REFACTURACION">REFACTURACION</option>
                    <option value="SOSTENIMIENTO">SOSTENIMIENTO</option>
                    <option value="DEVOLUCION DE DINERO">DEVOLUCION DE DINERO</option>
                </select>
            </div>
        </div>
        
        <div class="botones-accion">
            <button class="boton-refrescar" onclick="cargarRegistros()">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <button class="boton-exportar" onclick="exportarAExcel()">
                <i class="fas fa-file-excel"></i> Exportar a Excel
            </button>
        </div>
        
        <div class="tabla-contenedor">
            <table id="tabla-registros">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Gestor</th>
                        <th>N춿 Factura</th>
                        <th>Caso</th>
                        <th>Motivo</th>
                        <th>Proceso</th>
                        <th>Valor Sostenimiento</th>
                        <th>Corresponde a</th>
                        <th>Tiene Kazado</th>
                        <th>Bajo</th>
                        <th>Solicito Clave</th>
                        <th>Valor Producto</th>
                    </tr>
                </thead>
                <tbody id="cuerpo-tabla">
                    <tr>
                        <td colspan="12" class="cargando">
                            <i class="fas fa-spinner fa-spin"></i> Cargando registros...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="paginacion">
            <button id="btn-anterior" onclick="cambiarPagina(-1)" disabled>
                <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span id="info-pagina">P치gina 1 de 1</span>
            <button id="btn-siguiente" onclick="cambiarPagina(1)" disabled>
                Siguiente <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="contador-registros" id="contador-registros">
            Mostrando 0 registros
        </div>
    </div>

<script>
// URL de tu Web App de Google Apps Script para obtener datos
const GOOGLE_SCRIPT_GET_URL = "https://script.google.com/macros/s/AKfycbzqqqNXv2vhq5zYagH4MAe-fOgnGdQlQ-OoHl2xCWvBoI8Lpk9Obfca4Aa6iQNtATrF3A/exec";

// Variables globales
let todosLosRegistros = [];
let registrosFiltrados = [];
let paginaActual = 1;
const registrosPorPagina = 20;

// Cargar registros cuando la p치gina se carga
document.addEventListener('DOMContentLoaded', function() {
    cargarRegistros();
    cargarSelectorAnios();
    
    // Configurar event listeners para los filtros
    document.getElementById('filtro-fecha').addEventListener('change', aplicarFiltros);
    document.getElementById('filtro-mes').addEventListener('change', filtrarPorMes);
    document.getElementById('filtro-anio').addEventListener('change', filtrarPorMes);
    document.getElementById('filtro-gestor').addEventListener('change', aplicarFiltros);
    document.getElementById('filtro-factura').addEventListener('input', aplicarFiltros);
    document.getElementById('filtro-caso').addEventListener('input', aplicarFiltros);
    document.getElementById('filtro-motivo').addEventListener('change', aplicarFiltros);
    document.getElementById('filtro-proceso').addEventListener('change', aplicarFiltros);
    
    // Event listeners para el rango de fechas
    document.getElementById('filtro-fecha-inicio').addEventListener('change', aplicarFiltros);
    document.getElementById('filtro-fecha-fin').addEventListener('change', aplicarFiltros);
});

// Funci칩n para cargar el selector de a침os
function cargarSelectorAnios() {
    const selectorAnio = document.getElementById('filtro-anio');
    const anioActual = new Date().getFullYear();
    
    // Limpiar opciones existentes excepto la primera
    while (selectorAnio.options.length > 1) {
        selectorAnio.remove(1);
    }
    
    for (let i = anioActual; i >= 2020; i--) {
        const opcion = document.createElement('option');
        opcion.value = i;
        opcion.textContent = i;
        selectorAnio.appendChild(opcion);
    }
}

// Funci칩n para cargar registros desde Google Sheets
async function cargarRegistros() {
    try {
        document.getElementById('cuerpo-tabla').innerHTML = `
            <tr>
                <td colspan="12" class="cargando">
                    <i class="fas fa-spinner fa-spin"></i> Cargando registros...
                </td>
            </tr>
        `;
        
        // Usar un proxy para evitar problemas CORS
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        const targetUrl = GOOGLE_SCRIPT_GET_URL + '?action=getRecords';
        
        const respuesta = await fetch(proxyUrl + targetUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (!respuesta.ok) {
            throw new Error(`Error HTTP: ${respuesta.status}`);
        }
        
        const datos = await respuesta.json();
        
        // Verificar diferentes formatos de respuesta
        if (datos && datos.registros) {
            todosLosRegistros = datos.registros;
        } else if (Array.isArray(datos)) {
            // Si la respuesta es un array directamente
            todosLosRegistros = reformatearDatosArray(datos);
        } else {
            throw new Error('Formato de respuesta inesperado');
        }
        
        aplicarFiltros();
        
    } catch (error) {
        console.error("Error al cargar registros:", error);
        
        // Intentar sin proxy si falla
        try {
            const respuestaDirecta = await fetch(GOOGLE_SCRIPT_GET_URL + '?action=getRecords');
            if (respuestaDirecta.ok) {
                const datosDirectos = await respuestaDirecta.json();
                if (datosDirectos && datosDirectos.registros) {
                    todosLosRegistros = datosDirectos.registros;
                    aplicarFiltros();
                    return;
                }
            }
        } catch (errorDirecto) {
            console.error("Error en intento directo:", errorDirecto);
        }
        
        document.getElementById('cuerpo-tabla').innerHTML = `
            <tr>
                <td colspan="12" class="sin-registros">
                    <i class="fas fa-exclamation-triangle"></i> Error al cargar los registros. 
                    <br>Por favor, intente nuevamente.
                    <br><br>
                    <button onclick="cargarRegistros()" style="padding: 8px 15px; background-color: #000; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Reintentar
                    </button>
                </td>
            </tr>
        `;
    }
}

// Funci칩n auxiliar para reformatear datos si vienen como array
function reformatearDatosArray(datosArray) {
    if (datosArray.length <= 1) return [];
    
    const headers = datosArray[0];
    const registros = [];
    
    for (let i = 1; i < datosArray.length; i++) {
        const row = datosArray[i];
        const registro = {};
        
        for (let j = 0; j < headers.length; j++) {
            let propName = headers[j];
            if (propName === 'N칰mero de Factura') propName = 'numFactura';
            else if (propName === 'Valor del Sostenimiento') propName = 'valorSostenimiento';
            else if (propName === 'Corresponde a') propName = 'correspondeA';
            else if (propName === 'Tiene Kazado') propName = 'tieneKazado';
            else if (propName === 'Solicito Clave') propName = 'solicitoClave';
            else if (propName === 'Valor del Producto') propName = 'valorProducto';
            else propName = propName.toLowerCase();
            
            registro[propName] = row[j];
        }
        
        registros.push(registro);
    }
    
    return registros;
}

// Funci칩n para normalizar texto para b칰squedas
function normalizarTexto(texto) {
    if (!texto) return '';
    return String(texto).toLowerCase().trim();
}

// Funci칩n para aplicar filtros a los registros
function aplicarFiltros() {
    const filtroFecha = document.getElementById('filtro-fecha').value;
    const filtroGestor = document.getElementById('filtro-gestor').value;
    const filtroFactura = normalizarTexto(document.getElementById('filtro-factura').value);
    const filtroCaso = normalizarTexto(document.getElementById('filtro-caso').value);
    const filtroMotivo = document.getElementById('filtro-motivo').value;
    const filtroProceso = document.getElementById('filtro-proceso').value;
    const filtroFechaInicio = document.getElementById('filtro-fecha-inicio').value;
    const filtroFechaFin = document.getElementById('filtro-fecha-fin').value;
    
    console.log('Aplicando filtros - Rango:', filtroFechaInicio, 'a', filtroFechaFin);
    
    registrosFiltrados = todosLosRegistros.filter(registro => {
        // Filtro por fecha espec칤fica
        if (filtroFecha) {
            const fechaRegistro = convertirFechaFormato(registro.fecha);
            if (!fechaRegistro || fechaRegistro !== filtroFecha) {
                return false;
            }
        }
        
        // Filtro por rango de fechas (SOLO si hay valores)
        if (filtroFechaInicio || filtroFechaFin) {
            const fechaRegistro = convertirFechaFormato(registro.fecha);
            if (!fechaRegistro) return false;
            
            if (filtroFechaInicio && fechaRegistro < filtroFechaInicio) {
                return false;
            }
            
            if (filtroFechaFin && fechaRegistro > filtroFechaFin) {
                return false;
            }
        }
        
        // Resto de filtros
        if (filtroGestor && registro.gestor !== filtroGestor) return false;
        if (filtroFactura && registro.numFactura && !normalizarTexto(registro.numFactura).includes(filtroFactura)) return false;
        
        // FILTRO POR CASO - CORREGIDO
        if (filtroCaso) {
            // Verificar si existe la propiedad caso y si contiene el texto buscado
            const casoRegistro = registro.caso || registro.Caso || '';
            if (!normalizarTexto(casoRegistro).includes(filtroCaso)) {
                return false;
            }
        }
        
        if (filtroMotivo && registro.motivo !== filtroMotivo) return false;
        if (filtroProceso && registro.proceso !== filtroProceso) return false;
        
        return true;
    });
    
    // Reiniciar a la primera p치gina despu칠s de filtrar
    paginaActual = 1;
    mostrarRegistrosPaginados();
}

// Funci칩n para filtrar por mes y a침o (VERSI칍N CORREGIDA)
function filtrarPorMes() {
    const mes = document.getElementById('filtro-mes').value;
    const anio = document.getElementById('filtro-anio').value;

    if (mes && anio) {
        // Calcular primer y 칰ltimo d칤a del mes
        const fechaInicio = new Date(anio, mes - 1, 1);
        const fechaFin = new Date(anio, mes, 0);

        const fechaInicioFormato = fechaInicio.toISOString().split('T')[0];
        const fechaFinFormato = fechaFin.toISOString().split('T')[0];

        // Cargar directamente en el rango
        document.getElementById('filtro-fecha-inicio').value = fechaInicioFormato;
        document.getElementById('filtro-fecha-fin').value = fechaFinFormato;

        // Limpiar "fecha espec칤fica" para evitar conflicto
        document.getElementById('filtro-fecha').value = '';

        // 游댐 Aplicar los filtros al instante
        aplicarFiltros();
    }
}

// Funci칩n auxiliar para formatear fecha a YYYY-MM-DD
function formatDateToYYYYMMDD(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Funci칩n para aplicar rango de fechas manualmente
function aplicarRangoFechas() {
    // Limpiar filtro de mes y a침o
    document.getElementById('filtro-mes').value = '';
    document.getElementById('filtro-anio').value = '';
    
    // Limpiar filtro de fecha espec칤fica
    document.getElementById('filtro-fecha').value = '';
    
    aplicarFiltros();
}

// Funci칩n para convertir fecha al formato YYYY-MM-DD (MEJORADA)
function convertirFechaFormato(fechaStr) {
    if (!fechaStr) return null;
    
    try {
        // Si ya est치 en formato YYYY-MM-DD
        if (typeof fechaStr === 'string' && fechaStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return fechaStr;
        }
        
        // Para formato "12/9/2025, 2:53:50 p. m." o "12/09/2025, 02:53"
        if (typeof fechaStr === 'string' && fechaStr.match(/\d{1,2}\/\d{1,2}\/\d{4}/)) {
            // Extraer solo la parte de la fecha (antes de la coma)
            const parteFecha = fechaStr.split(',')[0].trim();
            const partes = parteFecha.split('/');
            
            // Asegurar formato de dos d칤gitos para d칤a y mes
            const dia = partes[0].padStart(2, '0');
            const mes = partes[1].padStart(2, '0');
            const anio = partes[2];
            
            return `${anio}-${mes}-${dia}`;
        }
        
        // Para timestamp de Google Sheets (formato de fecha serial)
        if (!isNaN(fechaStr) && fechaStr > 40000) {
            // Convertir fecha serial de Excel/Sheets a fecha JavaScript
            const fecha = new Date((fechaStr - 25569) * 86400 * 1000);
            return fecha.toISOString().split('T')[0];
        }
        
        // Para otros formatos, intentar con el constructor Date
        const fecha = new Date(fechaStr);
        if (!isNaN(fecha.getTime())) {
            return fecha.toISOString().split('T')[0];
        }
        
        return null;
    } catch (e) {
        console.error('Error convirtiendo fecha:', fechaStr, e);
        return null;
    }
}

// Funci칩n para mostrar registros paginados
function mostrarRegistrosPaginados() {
    const inicio = (paginaActual - 1) * registrosPorPagina;
    const fin = inicio + registrosPorPagina;
    const registrosPagina = registrosFiltrados.slice(inicio, fin);
    
    const cuerpoTabla = document.getElementById('cuerpo-tabla');
    
    if (registrosPagina.length === 0) {
        cuerpoTabla.innerHTML = `
            <tr>
                <td colspan="12" class="sin-registros">
                    No se encontraron registros que coincidan con los filtros aplicados.
                </td>
            </tr>
        `;
    } else {
        cuerpoTabla.innerHTML = '';
        registrosPagina.forEach(registro => {
            const fila = document.createElement('tr');
            
            // Obtener el valor del caso (manejar diferentes nombres de propiedad)
            const valorCaso = registro.caso || registro.Caso || '';
            
            fila.innerHTML = `
                <td>${formatearFecha(registro.fecha)}</td>
                <td>${registro.gestor || ''}</td>
                <td>${registro.numFactura || ''}</td>
                <td>${valorCaso}</td>
                <td>${registro.motivo || ''}</td>
                <td>${registro.proceso || ''}</td>
                <td>${registro.valorSostenimiento ? '$' + parseInt(registro.valorSostenimiento).toLocaleString() : ''}</td>
                <td>${registro.correspondeA || ''}</td>
                <td>${registro.tieneKazado || ''}</td>
                <td>${registro.bajo || ''}</td>
                <td>${registro.solicitoClave || ''}</td>
                <td>${registro.valorProducto ? '$' + parseInt(registro.valorProducto).toLocaleString() : ''}</td>
            `;
            cuerpoTabla.appendChild(fila);
        });
    }
    
    // Actualizar controles de paginaci칩n
    actualizarControlesPaginacion();
    
    // Actualizar contador de registros
    document.getElementById('contador-registros').textContent = 
        `Mostrando ${registrosFiltrados.length} registro(s)`;
}

// Funci칩n para formatear la fecha (versi칩n robusta)
function formatearFecha(fechaStr) {
    if (!fechaStr) return '';
    
    // Si ya est치 formateada correctamente, devolver tal cual
    if (typeof fechaStr === 'string' && fechaStr.match(/\d{2}\/\d{2}\/\d{4}.*\d{2}:\d{2}/)) {
        return fechaStr;
    }
    
    try {
        let fecha;
        
        // Intentar diferentes patrones de fecha
        if (typeof fechaStr === 'string') {
            // Patr칩n 1: "dd/mm/yyyy hh:mm"
            const patron1 = fechaStr.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})[^\d]*(\d{1,2})[^\d]*(\d{1,2})/);
            if (patron1) {
                fecha = new Date(patron1[3], patron1[2] - 1, patron1[1], patron1[4], patron1[5]);
            }
            
            // Patr칩n 2: "yyyy-mm-dd hh:mm:ss"
            if ((!fecha || isNaN(fecha.getTime())) && fechaStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                fecha = new Date(fechaStr);
            }
            
            // Patr칩n 3: Timestamp de Google Sheets (n칰mero de serie)
            if ((!fecha || isNaN(fecha.getTime())) && !isNaN(fechaStr)) {
                // Google Sheets usa el formato de fecha de Excel (d칤as desde 1900-01-01)
                const timestamp = parseInt(fechaStr);
                if (timestamp > 2000) { // Es probablemente un timestamp Unix
                    fecha = new Date(timestamp);
                } else if (timestamp > 0) { // Es probablemente un d칤a serial de Excel/Sheets
                    // Los dates en Google Sheets son d칤as desde 1900-01-01
                    fecha = new Date((timestamp - 25569) * 86400 * 1000);
                }
            }
            
            // 칔ltimo intento: constructor Date nativo
            if (!fecha || isNaN(fecha.getTime())) {
                fecha = new Date(fechaStr);
            }
        } else if (typeof fechaStr === 'number') {
            // Si es un timestamp num칠rico
            fecha = new Date(fechaStr);
        }
        
        // Si despu칠s de todos los intentos no tenemos una fecha v치lida
        if (!fecha || isNaN(fecha.getTime())) {
            return String(fechaStr); // Devolver como string
        }
        
        // Formatear la fecha correctamente
        return fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        
    } catch (e) {
        console.error('Error formateando fecha:', fechaStr, e);
        return String(fechaStr);
    }
}

// Funci칩n para actualizar controles de paginaci칩n
function actualizarControlesPaginacion() {
    const totalPaginas = Math.ceil(registrosFiltrados.length / registrosPorPagina);
    
    document.getElementById('btn-anterior').disabled = paginaActual <= 1;
    document.getElementById('btn-siguiente').disabled = paginaActual >= totalPaginas;
    document.getElementById('info-pagina').textContent = `P치gina ${paginaActual} de ${totalPaginas}`;
}

// Funci칩n para cambiar de p치gina
function cambiarPagina(direccion) {
    const totalPaginas = Math.ceil(registrosFiltrados.length / registrosPorPagina);
    paginaActual += direccion;
    
    if (paginaActual < 1) paginaActual = 1;
    if (paginaActual > totalPaginas) paginaActual = totalPaginas;
    
    mostrarRegistrosPaginados();
}

// Funci칩n para exportar a Excel
function exportarAExcel() {
    if (registrosFiltrados.length === 0) {
        alert('No hay registros para exportar.');
        return;
    }
    
    // Preparar datos para exportaci칩n
    const datosExportar = registrosFiltrados.map(registro => {
        // Obtener el valor del caso (manejar diferentes nombres de propiedad)
        const valorCaso = registro.caso || registro.Caso || '';
        
        return {
            'Fecha': formatearFecha(registro.fecha),
            'Gestor': registro.gestor || '',
            'N칰mero de Factura': registro.numFactura || '',
            'Caso': valorCaso,
            'Motivo': registro.motivo || '',
            'Proceso': registro.proceso || '',
            'Valor Sostenimiento': registro.valorSostenimiento || '',
            'Corresponde a': registro.correspondeA || '',
            'Tiene Kazado': registro.tieneKazado || '',
            'Bajo': registro.bajo || '',
            'Solicito Clave': registro.solicitoClave || '',
            'Valor Producto': registro.valorProducto || ''
        };
    });
    
    // Crear libro de trabajo y hoja
    const libro = XLSX.utils.book_new();
    const hoja = XLSX.utils.json_to_sheet(datosExportar);
    
    // Ajustar el ancho de las columnas
    const anchosColumnas = [
        {wch: 20}, // Fecha
        {wch: 25}, // Gestor
        {wch: 18}, // N칰mero de Factura
        {wch: 15}, // Caso
        {wch: 15}, // Motivo
        {wch: 18}, // Proceso
        {wch: 20}, // Valor Sostenimiento
        {wch: 15}, // Corresponde a
        {wch: 12}, // Tiene Kazado
        {wch: 10}, // Bajo
        {wch: 15}, // Solicito Clave
        {wch: 15}  // Valor Producto
    ];
    hoja['!cols'] = anchosColumnas;
    
    // A침adir hoja al libro
    XLSX.utils.book_append_sheet(libro, hoja, 'Registros CONFIRN');
    
    // Generar archivo y descargar
    const fechaExportacion = new Date().toISOString().split('T')[0];
    XLSX.writeFile(libro, `registros_caja_${fechaExportacion}.xlsx`);
}
</script>
</body>
</html>