<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Registros - CONFIRN</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            min-width: 100vw;
            overflow-x: hidden;
            color: #333;
        }
        .titulo {
            width: 100%;
            background: linear-gradient(135deg, #000000 0%, #2c3e50 100%);
            text-align: center;
            color: white;
            margin-bottom: 0px;
            padding: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .titulo h1 {
            margin: 0;
            font-size: 2.2rem;
        }
        .botones-container {
            background-color: #000000;
            margin-top: 0px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding: 20px 0;
            border: 40px solid #000000;
            box-sizing: border-box;
        }
        .botones-container button {
            background-color: #3498db;
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 30px;
            margin: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .botones-container button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .botones-container button i {
            margin-right: 8px;
        }
        
        .contenedor-registros {
            width: 95%;
            max-width: 1600px;
            margin: 20px auto;
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .contenedor-registros h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
            margin-top: 0;
        }
        
        .filtros-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .filtro-grupo {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            flex: 1;
        }
        
        .filtro-grupo label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .filtro-grupo input, .filtro-grupo select {
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 15px;
            background-color: white;
        }
        
        .botones-accion {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .boton-exportar {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .boton-exportar:hover {
            background-color: #219653;
        }
        
        .boton-refrescar {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .boton-refrescar:hover {
            background-color: #2980b9;
        }
        
        .tabla-contenedor {
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .paginacion {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 15px;
        }
        
        .paginacion button {
            padding: 10px 18px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .paginacion button:hover {
            background-color: #1a2530;
        }
        
        .paginacion button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .contador-registros {
            margin-top: 15px;
            text-align: right;
            font-style: italic;
            color: #7f8c8d;
        }
        
        .cargando {
            text-align: center;
            padding: 30px;
            font-size: 18px;
            color: #7f8c8d;
        }
        
        .sin-registros {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .filtro-rango {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .filtro-rango button {
            padding: 10px 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filtro-rango button:hover {
            background-color: #1a2530;
        }
        
        .error-panel {
            background-color: #ffeaea;
            border-left: 5px solid #e74c3c;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }
        
        .error-panel h3 {
            color: #e74c3c;
            margin-top: 0;
        }
        
        .error-panel ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        
        .error-panel li {
            margin-bottom: 8px;
        }
        
        .solucion-pasos {
            background-color: #e8f4fd;
            border-left: 5px solid #3498db;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }
        
        .solucion-pasos h3 {
            color: #3498db;
            margin-top: 0;
        }
        
        @media (max-width: 1024px) {
            .filtros-container {
                flex-direction: column;
            }
            
            .filtro-grupo {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .botones-accion {
                flex-direction: column;
            }
            
            .filtro-rango {
                flex-direction: column;
                align-items: stretch;
            }
            
            .titulo h1 {
                font-size: 1.8rem;
            }
            
            .contenedor-registros {
                padding: 15px;
            }
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #27ae60;
        }
        
        .status-offline {
            background-color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="titulo">
        <h1><i class="fas fa-history"></i> Historial de Registros - CONFIRN</h1>
    </div>
    <div class="botones-container">
        <button onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i> Volver al Formulario</button>
        <button onclick="window.location.href='PLANTILLAS_DEVOLUCIONES.html'"><i class="fas fa-file-pdf"></i> Generador PDF</button>
    </div>

    <div class="contenedor-registros">
        <h2><i class="fas fa-table"></i> Registros Guardados</h2>
        
        <div class="error-panel">
            <h3><i class="fas fa-exclamation-triangle"></i> Error de Conexi√≥n</h3>
            <p>Se ha producido un error al intentar conectar con Google Sheets. Aunque los datos se guardan correctamente, la visualizaci√≥n no funciona debido a restricciones de seguridad del navegador.</p>
            <p><strong>Soluci√≥n:</strong> Sigue estos pasos para resolver el problema:</p>
            <ol>
                <li>Abre tu script de Google Apps Script</li>
                <li>Haz clic en "Desplegar" > "Configuraci√≥n de despliegue"</li>
                <li>En "Qui√©n tiene acceso", selecciona "Cualquier persona"</li>
                <li>Guarda la configuraci√≥n y vuelve a desplegar la aplicaci√≥n</li>
                <li>Actualiza esta p√°gina y prueba de nuevo</li>
            </ol>
        </div>
        
        <div class="solucion-pasos">
            <h3><i class="fas fa-lightbulb"></i> Soluci√≥n Alternativa</h3>
            <p>Si el problema persiste, intenta estas soluciones alternativas:</p>
            <ul>
                <li>Abre la consola de desarrollador (F12) y revisa si hay errores CORS</li>
                <li>Prueba a acceder desde otro navegador</li>
                <li>Verifica que la URL de tu script de Google Apps sea correcta</li>
                <li>Espera unos minutos y vuelve a intentarlo (a veces hay demoras en la propagaci√≥n)</li>
            </ul>
        </div>
        
        <div class="filtros-container">
            <div class="filtro-grupo">
                <label for="filtro-fecha"><i class="fas fa-calendar-day"></i> Fecha espec√≠fica</label>
                <input type="date" id="filtro-fecha">
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-mes"><i class="fas fa-calendar-alt"></i> Filtrar por mes</label>
                <select id="filtro-mes">
                    <option value="">Seleccionar mes</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-anio"><i class="fas fa-calendar"></i> A√±o</label>
                <select id="filtro-anio">
                    <option value="">Seleccionar a√±o</option>
                </select>
            </div>
            
            <div class="filtro-grupo">
                <label><i class="fas fa-calendar-week"></i> Rango de fechas</label>
                <div class="filtro-rango">
                    <div>
                        <label for="filtro-fecha-inicio" style="font-size: 12px;">Desde</label>
                        <input type="date" id="filtro-fecha-inicio">
                    </div>
                    <div>
                        <label for="filtro-fecha-fin" style="font-size: 12px;">Hasta</label>
                        <input type="date" id="filtro-fecha-fin">
                    </div>
                    <button onclick="aplicarRangoFechas()"><i class="fas fa-filter"></i> Filtrar</button>
                </div>
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-gestor"><i class="fas fa-user"></i> Gestor</label>
                <select id="filtro-gestor">
                    <option value="">Todos los gestores</option>
                    <option value="LUIS FERNANDO GUTIERREZ TORRES">LUIS FERNANDO GUTIERREZ TORRES</option>
                    <option value="JOSE EXNEYDER HOYOS VARGAS">JOSE EXNEYDER HOYOS VARGAS</option>
                    <option value="CARLOS EDUARDO CASAS">CARLOS EDUARDO CASAS</option>
                    <option value="JUAN MANUEL PUENTES POLANIA">JUAN MANUEL PUENTES POLANIA</option>
                    <option value="JOHAN SEBASTIAN OVALLE">JOHAN SEBASTIAN OVALLE</option>
                    <option value="CARLOS CA√ëAS">CARLOS CA√ëAS</option>
                    <option value="ERIK HERNANDEZ">ERIK HERNANDEZ</option>
                    <option value="KARELLY QUITIAN URREA">KARELLY QUITIAN URREA</option>
                    <option value="DANIELA DUCUARA QUESADA">DANIELA DUCUARA QUESADA</option>
                    <option value="BENJAMIN PRIETO">BENJAMIN PRIETO</option>
                    <option value="CRISTIAN FERNANDO BERNAL OVIEDO">CRISTIAN FERNANDO BERNAL OVIEDO</option>
                    <option value="ANA LILIANA MARQUEZ">ANA LILIANA MARQUEZ</option>
                </select>
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-factura"><i class="fas fa-file-invoice-dollar"></i> N¬∞ Factura</label>
                <input type="text" id="filtro-factura" placeholder="Buscar por factura">
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-caso"><i class="fas fa-folder-open"></i> Caso</label>
                <input type="text" id="filtro-caso" placeholder="Buscar por caso">
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-motivo"><i class="fas fa-exclamation-circle"></i> Motivo</label>
                <select id="filtro-motivo">
                    <option value="">Todos los motivos</option>
                    <option value="FALLA">FALLA</option>
                    <option value="INSATISFACCION">INSATISFACCION</option>
                    <option value="INCOMPLETO">INCOMPLETO</option>
                    <option value="DETERIORADO">DETERIORADO</option>
                    <option value="PANTALLA ROTA">PANTALLA ROTA</option>
                </select>
            </div>
            
            <div class="filtro-grupo">
                <label for="filtro-proceso"><i class="fas fa-cogs"></i> Proceso</label>
                <select id="filtro-proceso">
                    <option value="">Todos los procesos</option>
                    <option value="BONO DEVOLUCION">BONO DEVOLUCION</option>
                    <option value="BONO SERVICIO">BONO SERVICIO</option>
                    <option value="REFACTURACION">REFACTURACION</option>
                    <option value="SOSTENIMIENTO">SOSTENIMIENTO</option>
                    <option value="DEVOLUCION DE DINERO">DEVOLUCION DE DINERO</option>
                </select>
            </div>
        </div>
        
        <div class="botones-accion">
            <button class="boton-refrescar" onclick="cargarRegistros()">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <button class="boton-exportar" onclick="exportarAExcel()">
                <i class="fas fa-file-excel"></i> Exportar a Excel
            </button>
        </div>
        
        <div class="tabla-contenedor">
            <table id="tabla-registros">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Gestor</th>
                        <th>N¬∞ Factura</th>
                        <th>Caso</th>
                        <th>Motivo</th>
                        <th>Proceso</th>
                        <th>Valor Sostenimiento</th>
                        <th>Corresponde a</th>
                        <th>Tiene Kazado</th>
                        <th>Bajo</th>
                        <th>Solicito Clave</th>
                        <th>Valor Producto</th>
                    </tr>
                </thead>
                <tbody id="cuerpo-tabla">
                    <tr>
                        <td colspan="12" class="cargando">
                            <i class="fas fa-spinner fa-spin"></i> Cargando registros...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="paginacion">
            <button id="btn-anterior" onclick="cambiarPagina(-1)" disabled>
                <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span id="info-pagina">P√°gina 1 de 1</span>
            <button id="btn-siguiente" onclick="cambiarPagina(1)" disabled>
                Siguiente <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="contador-registros" id="contador-registros">
            <span class="status-indicator status-offline"></span>Conectando a Google Sheets...
        </div>
    </div>

<script>
// URL de tu Web App de Google Apps Script para obtener datos
const GOOGLE_SCRIPT_GET_URL = "https://script.google.com/macros/s/AKfycbxwe8VEBfLUJOzqamSzW7FUWSc5CipweOKb5-g_zJM4SAKAh6ovz9ZkzEM13eNmd1kKiw/exec";

// Variables globales
let todosLosRegistros = [];
let registrosFiltrados = [];
let paginaActual = 1;
const registrosPorPagina = 20;

// Cargar registros cuando la p√°gina se carga
document.addEventListener('DOMContentLoaded', function() {
    cargarRegistros();
    cargarSelectorAnios();
    
    // Configurar event listeners para los filtros
    document.getElementById('filtro-fecha').addEventListener('change', aplicarFiltros);
    document.getElementById('filtro-mes').addEventListener('change', filtrarPorMes);
    document.getElementById('filtro-anio').addEventListener('change', filtrarPorMes);
    document.getElementById('filtro-gestor').addEventListener('change', aplicarFiltros);
    document.getElementById('filtro-factura').addEventListener('input', aplicarFiltros);
    document.getElementById('filtro-caso').addEventListener('input', aplicarFiltros);
    document.getElementById('filtro-motivo').addEventListener('change', aplicarFiltros);
    document.getElementById('filtro-proceso').addEventListener('change', aplicarFiltros);
    
    // Event listeners para el rango de fechas
    document.getElementById('filtro-fecha-inicio').addEventListener('change', aplicarFiltros);
    document.getElementById('filtro-fecha-fin').addEventListener('change', aplicarFiltros);
});

// Funci√≥n para cargar el selector de a√±os
function cargarSelectorAnios() {
    const selectorAnio = document.getElementById('filtro-anio');
    const anioActual = new Date().getFullYear();
    
    // Limpiar opciones existentes excepto la primera
    while (selectorAnio.options.length > 1) {
        selectorAnio.remove(1);
    }
    
    for (let i = anioActual; i >= 2020; i--) {
        const opcion = document.createElement('option');
        opcion.value = i;
        opcion.textContent = i;
        selectorAnio.appendChild(opcion);
    }
}

// Funci√≥n para cargar registros desde Google Sheets
async function cargarRegistros() {
    try {
        document.getElementById('cuerpo-tabla').innerHTML = `
            <tr>
                <td colspan="12" class="cargando">
                    <i class="fas fa-spinner fa-spin"></i> Cargando registros...
                </td>
            </tr>
        `;
        
        // Actualizar estado de conexi√≥n
        document.getElementById('contador-registros').innerHTML = 
            '<span class="status-indicator status-offline"></span>Conectando a Google Sheets...';
        
        // Usar fetch directamente sin proxy (Google Apps Script maneja CORS)
        const targetUrl = GOOGLE_SCRIPT_GET_URL + '?action=getRecords&timestamp=' + new Date().getTime();
        
        const respuesta = await fetch(targetUrl);
        
        if (!respuesta.ok) {
            throw new Error(`Error HTTP: ${respuesta.status} - ${respuesta.statusText}`);
        }
        
        const datos = await respuesta.json();
        
        // Verificar diferentes formatos de respuesta
        if (datos && datos.registros) {
            todosLosRegistros = datos.registros;
        } else if (Array.isArray(datos)) {
            // Si la respuesta es un array directamente
            todosLosRegistros = reformatearDatosArray(datos);
        } else {
            throw new Error('Formato de respuesta inesperado');
        }
        
        // Actualizar estado de conexi√≥n
        document.getElementById('contador-registros').innerHTML = 
            `<span class="status-indicator status-online"></span>Conectado - ${todosLosRegistros.length} registros cargados`;
        
        aplicarFiltros();
        
    } catch (error) {
        console.error("Error al cargar registros:", error);
        
        // Actualizar estado de conexi√≥n
        document.getElementById('contador-registros').innerHTML = 
            '<span class="status-indicator status-offline"></span>Error de conexi√≥n';
        
        document.getElementById('cuerpo-tabla').innerHTML = `
            <tr>
                <td colspan="12" class="sin-registros">
                    <i class="fas fa-exclamation-triangle"></i> Error al cargar los registros. 
                    <br>Detalles: ${error.message || 'Error desconocido'}
                    <br><br>
                    <button onclick="cargarRegistros()" style="padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 5px;">
                        <i class="fas fa-sync-alt"></i> Reintentar
                    </button>
                </td>
            </tr>
        `;
    }
}

// Funci√≥n auxiliar para reformatear datos si vienen como array
function reformatearDatosArray(datosArray) {
    if (datosArray.length <= 1) return [];
    
    const headers = datosArray[0];
    const registros = [];
    
    for (let i = 1; i < datosArray.length; i++) {
        const row = datosArray[i];
        const registro = {};
        
        for (let j = 0; j < headers.length; j++) {
            let propName = headers[j];
            if (propName === 'N√∫mero de Factura') propName = 'numFactura';
            else if (propName === 'Valor del Sostenimiento') propName = 'valorSostenimiento';
            else if (propName === 'Corresponde a') propName = 'correspondeA';
            else if (propName === 'Tiene Kazado') propName = 'tieneKazado';
            else if (propName === 'Solicito Clave') propName = 'solicitoClave';
            else if (propName === 'Valor del Producto') propName = 'valorProducto';
            else if (propName === 'Fecha') propName = 'fecha';
            else if (propName === 'Gestor') propName = 'gestor';
            else if (propName === 'Caso') propName = 'caso';
            else if (propName === 'Motivo') propName = 'motivo';
            else if (propName === 'Proceso') propName = 'proceso';
            else if (propName === 'Bajo') propName = 'bajo';
            else propName = propName.toLowerCase().replace(/\s+/g, '_');
            
            registro[propName] = row[j];
        }
        
        registros.push(registro);
    }
    
    return registros;
}

// Funci√≥n para normalizar texto para b√∫squedas
function normalizarTexto(texto) {
    if (!texto) return '';
    return String(texto).toLowerCase().trim();
}

// Funci√≥n para aplicar filtros a los registros
function aplicarFiltros() {
    const filtroFecha = document.getElementById('filtro-fecha').value;
    const filtroGestor = document.getElementById('filtro-gestor').value;
    const filtroFactura = normalizarTexto(document.getElementById('filtro-factura').value);
    const filtroCaso = normalizarTexto(document.getElementById('filtro-caso').value);
    const filtroMotivo = document.getElementById('filtro-motivo').value;
    const filtroProceso = document.getElementById('filtro-proceso').value;
    const filtroFechaInicio = document.getElementById('filtro-fecha-inicio').value;
    const filtroFechaFin = document.getElementById('filtro-fecha-fin').value;
    
    registrosFiltrados = todosLosRegistros.filter(registro => {
        // Filtro por fecha espec√≠fica
        if (filtroFecha) {
            const fechaRegistro = convertirFechaFormato(registro.fecha);
            if (!fechaRegistro || fechaRegistro !== filtroFecha) {
                return false;
            }
        }
        
        // Filtro por rango de fechas (SOLO si hay valores)
        if (filtroFechaInicio || filtroFechaFin) {
            const fechaRegistro = convertirFechaFormato(registro.fecha);
            if (!fechaRegistro) return false;
            
            if (filtroFechaInicio && fechaRegistro < filtroFechaInicio) {
                return false;
            }
            
            if (filtroFechaFin && fechaRegistro > filtroFechaFin) {
                return false;
            }
        }
        
        // Resto de filtros
        if (filtroGestor && registro.gestor !== filtroGestor) return false;
        if (filtroFactura && registro.numFactura && !normalizarTexto(registro.numFactura).includes(filtroFactura)) return false;
        
        // FILTRO POR CASO - CORREGIDO
        if (filtroCaso) {
            // Verificar si existe la propiedad caso y si contiene el texto buscado
            const casoRegistro = registro.caso || registro.Caso || '';
            if (!normalizarTexto(casoRegistro).includes(filtroCaso)) {
                return false;
            }
        }
        
        if (filtroMotivo && registro.motivo !== filtroMotivo) return false;
        if (filtroProceso && registro.proceso !== filtroProceso) return false;
        
        return true;
    });
    
    // Reiniciar a la primera p√°gina despu√©s de filtrar
    paginaActual = 1;
    mostrarRegistrosPaginados();
}

// Funci√≥n para filtrar por mes y a√±o (VERSI√ìN CORREGIDA)
function filtrarPorMes() {
    const mes = document.getElementById('filtro-mes').value;
    const anio = document.getElementById('filtro-anio').value;

    if (mes && anio) {
        // Calcular primer y √∫ltimo d√≠a del mes
        const fechaInicio = new Date(anio, mes - 1, 1);
        const fechaFin = new Date(anio, mes, 0);

        const fechaInicioFormato = fechaInicio.toISOString().split('T')[0];
        const fechaFinFormato = fechaFin.toISOString().split('T')[0];

        // Cargar directamente en el rango
        document.getElementById('filtro-fecha-inicio').value = fechaInicioFormato;
        document.getElementById('filtro-fecha-fin').value = fechaFinFormato;

        // Limpiar "fecha espec√≠fica" para evitar conflicto
        document.getElementById('filtro-fecha').value = '';

        // üîë Aplicar los filtros al instante
        aplicarFiltros();
    }
}

// Funci√≥n auxiliar para formatear fecha a YYYY-MM-DD
function formatDateToYYYYMMDD(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Funci√≥n para aplicar rango de fechas manualmente
function aplicarRangoFechas() {
    // Limpiar filtro de mes y a√±o
    document.getElementById('filtro-mes').value = '';
    document.getElementById('filtro-anio').value = '';
    
    // Limpiar filtro de fecha espec√≠fica
    document.getElementById('filtro-fecha').value = '';
    
    aplicarFiltros();
}

// Funci√≥n para convertir fecha al formato YYYY-MM-DD (MEJORADA)
function convertirFechaFormato(fechaStr) {
    if (!fechaStr) return null;
    
    try {
        // Si ya est√° en formato YYYY-MM-DD
        if (typeof fechaStr === 'string' && fechaStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return fechaStr;
        }
        
        // Para formato "12/9/2025, 2:53:50 p. m." o "12/09/2025, 02:53"
        if (typeof fechaStr === 'string' && fechaStr.match(/\d{1,2}\/\d{1,2}\/\d{4}/)) {
            // Extraer solo la parte de la fecha (antes de la coma)
            const parteFecha = fechaStr.split(',')[0].trim();
            const partes = parteFecha.split('/');
            
            // Asegurar formato de dos d√≠gitos para d√≠a y mes
            const dia = partes[0].padStart(2, '0');
            const mes = partes[1].padStart(2, '0');
            const anio = partes[2];
            
            return `${anio}-${mes}-${dia}`;
        }
        
        // Para timestamp de Google Sheets (formato de fecha serial)
        if (!isNaN(fechaStr) && fechaStr > 40000) {
            // Convertir fecha serial de Excel/Sheets a fecha JavaScript
            const fecha = new Date((fechaStr - 25569) * 86400 * 1000);
            return fecha.toISOString().split('T')[0];
        }
        
        // Para otros formatos, intentar con el constructor Date
        const fecha = new Date(fechaStr);
        if (!isNaN(fecha.getTime())) {
            return fecha.toISOString().split('T')[0];
        }
        
        return null;
    } catch (e) {
        console.error('Error convirtiendo fecha:', fechaStr, e);
        return null;
    }
}

// Funci√≥n para mostrar registros paginados
function mostrarRegistrosPaginados() {
    const inicio = (paginaActual - 1) * registrosPorPagina;
    const fin = inicio + registrosPorPagina;
    const registrosPagina = registrosFiltrados.slice(inicio, fin);
    
    const cuerpoTabla = document.getElementById('cuerpo-tabla');
    
    if (registrosPagina.length === 0) {
        cuerpoTabla.innerHTML = `
            <tr>
                <td colspan="12" class="sin-registros">
                    No se encontraron registros que coincidan con los filtros aplicados.
                </td>
            </tr>
        `;
    } else {
        cuerpoTabla.innerHTML = '';
        registrosPagina.forEach(registro => {
            const fila = document.createElement('tr');
            
            // Obtener el valor del caso (manejar diferentes nombres de propiedad)
            const valorCaso = registro.caso || registro.Caso || '';
            
            fila.innerHTML = `
                <td>${formatearFecha(registro.fecha)}</td>
                <td>${registro.gestor || ''}</td>
                <td>${registro.numFactura || ''}</td>
                <td>${valorCaso}</td>
                <td>${registro.motivo || ''}</td>
                <td>${registro.proceso || ''}</td>
                <td>${registro.valorSostenimiento ? '$' + formatoMoneda(registro.valorSostenimiento) : ''}</td>
                <td>${registro.correspondeA || ''}</td>
                <td>${registro.tieneKazado || ''}</td>
                <td>${registro.bajo || ''}</td>
                <td>${registro.solicitoClave || ''}</td>
                <td>${registro.valorProducto ? '$' + formatoMoneda(registro.valorProducto) : ''}</td>
            `;
            cuerpoTabla.appendChild(fila);
        });
    }
    
    // Actualizar controles de paginaci√≥n
    actualizarControlesPaginacion();
    
    // Actualizar contador de registros
    document.getElementById('contador-registros').innerHTML = 
        `<span class="status-indicator status-online"></span>Mostrando ${registrosFiltrados.length} registro(s)`;
}

// Funci√≥n para formatear la fecha (versi√≥n robusta)
function formatearFecha(fechaStr) {
    if (!fechaStr) return '';
    
    // Si ya est√° formateada correctamente, devolver tal cual
    if (typeof fechaStr === 'string' && fechaStr.match(/\d{2}\/\d{2}\/\d{4}.*\d{2}:\d{2}/)) {
        return fechaStr;
    }
    
    try {
        let fecha;
        
        // Intentar diferentes patrones de fecha
        if (typeof fechaStr === 'string') {
            // Patr√≥n 1: "dd/mm/yyyy hh:mm"
            const patron1 = fechaStr.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})[^\d]*(\d{1,2})[^\d]*(\d{1,2})/);
            if (patron1) {
                fecha = new Date(patron1[3], patron1[2] - 1, patron1[1], patron1[4], patron1[5]);
            }
            
            // Patr√≥n 2: "yyyy-mm-dd hh:mm:ss"
            if ((!fecha || isNaN(fecha.getTime())) && fechaStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                fecha = new Date(fechaStr);
            }
            
            // Patr√≥n 3: Timestamp de Google Sheets (n√∫mero de serie)
            if ((!fecha || isNaN(fecha.getTime())) && !isNaN(fechaStr)) {
                // Google Sheets usa el formato de fecha de Excel (d√≠as desde 1900-01-01)
                const timestamp = parseInt(fechaStr);
                if (timestamp > 2000) { // Es probablemente un timestamp Unix
                    fecha = new Date(timestamp);
                } else if (timestamp > 0) { // Es probablemente un d√≠a serial de Excel/Sheets
                    // Los dates en Google Sheets son d√≠as desde 1900-01-01
                    fecha = new Date((timestamp - 25569) * 86400 * 1000);
                }
            }
            
            // √öltimo intento: constructor Date nativo
            if (!fecha || isNaN(fecha.getTime())) {
                fecha = new Date(fechaStr);
            }
        } else if (typeof fechaStr === 'number') {
            // Si es un timestamp num√©rico
            fecha = new Date(fechaStr);
        }
        
        // Si despu√©s de todos los intentos no tenemos una fecha v√°lida
        if (!fecha || isNaN(fecha.getTime())) {
            return String(fechaStr); // Devolver como string
        }
        
        // Formatear la fecha correctamente
        return fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        
    } catch (e) {
        console.error('Error formateando fecha:', fechaStr, e);
        return String(fechaStr);
    }
}

// Funci√≥n para formatear montos de dinero
function formatoMoneda(valor) {
    const num = parseInt(valor);
    return isNaN(num) ? '0' : num.toLocaleString();
}

// Funci√≥n para actualizar controles de paginaci√≥n
function actualizarControlesPaginacion() {
    const totalPaginas = Math.ceil(registrosFiltrados.length / registrosPorPagina);
    
    document.getElementById('btn-anterior').disabled = paginaActual <= 1;
    document.getElementById('btn-siguiente').disabled = paginaActual >= totalPaginas;
    document.getElementById('info-pagina').textContent = `P√°gina ${paginaActual} de ${totalPaginas}`;
}

// Funci√≥n para cambiar de p√°gina
function cambiarPagina(direccion) {
    const totalPaginas = Math.ceil(registrosFiltrados.length / registrosPorPagina);
    paginaActual += direccion;
    
    if (paginaActual < 1) paginaActual = 1;
    if (paginaActual > totalPaginas) paginaActual = totalPaginas;
    
    mostrarRegistrosPaginados();
}

// Funci√≥n para exportar a Excel
function exportarAExcel() {
    if (registrosFiltrados.length === 0) {
        alert('No hay registros para exportar.');
        return;
    }
    
    // Preparar datos para exportaci√≥n
    const datosExportar = registrosFiltrados.map(registro => {
        // Obtener el valor del caso (manejar diferentes nombres de propiedad)
        const valorCaso = registro.caso || registro.Caso || '';
        
        return {
            'Fecha': formatearFecha(registro.fecha),
            'Gestor': registro.gestor || '',
            'N√∫mero de Factura': registro.numFactura || '',
            'Caso': valorCaso,
            'Motivo': registro.motivo || '',
            'Proceso': registro.proceso || '',
            'Valor Sostenimiento': registro.valorSostenimiento || '',
            'Corresponde a': registro.correspondeA || '',
            'Tiene Kazado': registro.tieneKazado || '',
            'Bajo': registro.bajo || '',
            'Solicito Clave': registro.solicitoClave || '',
            'Valor Producto': registro.valorProducto || ''
        };
    });
    
    // Crear libro de trabajo y hoja
    const libro = XLSX.utils.book_new();
    const hoja = XLSX.utils.json_to_sheet(datosExportar);
    
    // Ajustar el ancho de las columnas
    const anchosColumnas = [
        {wch: 20}, // Fecha
        {wch: 25}, // Gestor
        {wch: 18}, // N√∫mero de Factura
        {wch: 15}, // Caso
        {wch: 15}, // Motivo
        {wch: 18}, // Proceso
        {wch: 20}, // Valor Sostenimiento
        {wch: 15}, // Corresponde a
        {wch: 12}, // Tiene Kazado
        {wch: 10}, // Bajo
        {wch: 15}, // Solicito Clave
        {wch: 15}  // Valor Producto
    ];
    hoja['!cols'] = anchosColumnas;
    
    // A√±adir hoja al libro
    XLSX.utils.book_append_sheet(libro, hoja, 'Registros CONFIRN');
    
    // Generar archivo y descargar
    const fechaExportacion = new Date().toISOString().split('T')[0];
    XLSX.writeFile(libro, `registros_caja_${fechaExportacion}.xlsx`);
}
</script>
</body>
</html>